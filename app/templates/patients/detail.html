{% extends "base.html" %}
{% block content %}
<div class="patient-header">
  <h1>{{ patient.first_name }} {{ patient.last_name }}</h1>
  <div class="patient-status">
    <span class="status-badge status-{{ patient.status }}">{{ patient.status.title() }}</span>
    {% if patient.priority != 'normal' %}
    <span class="priority-badge priority-{{ patient.priority }}">{{ patient.priority.title() }} Priority</span>
    {% endif %}
  </div>
</div>

<div class="patient-actions">
  <a class="button" href="{{ url_for('patients.edit', id=patient.id) }}">Edit Patient</a>
  <a class="button secondary" href="{{ url_for('patients.edit_status', id=patient.id) }}">Update Status</a>
  <a class="button secondary" href="{{ url_for('appointments.create') }}?patient={{ patient.id }}">Schedule Appointment</a>
  <a class="button secondary" href="{{ url_for('patients.list') }}">Back to Patients</a>
</div>

<div class="patient-details-grid">
  <!-- Basic Information -->
  <div class="detail-card">
    <h2>Patient Information</h2>
    <div class="detail-row">
      <label>NHS Number:</label>
      <span>{{ patient.nhs_number }}</span>
    </div>
    <div class="detail-row">
      <label>Date of Birth:</label>
      <span>{{ patient.date_of_birth.strftime('%d %B %Y') }} (Age: {{ patient.age }})</span>
    </div>
    <div class="detail-row">
      <label>Phone:</label>
      <span>{{ patient.contact_phone or 'Not provided' }}</span>
    </div>
    <div class="detail-row">
      <label>Email:</label>
      <span>{{ patient.contact_email or 'Not provided' }}</span>
    </div>
    <div class="detail-row">
      <label>Registered:</label>
      <span>{{ patient.created_at.strftime('%d %B %Y at %H:%M') }}</span>
    </div>
    {% if patient.updated_at != patient.created_at %}
    <div class="detail-row">
      <label>Last Updated:</label>
      <span>{{ patient.updated_at.strftime('%d %B %Y at %H:%M') }}</span>
    </div>
    {% endif %}
  </div>

  <!-- Medical Information -->
  <div class="detail-card">
    <h2>Medical Status</h2>
    <div class="detail-row">
      <label>Current Status:</label>
      <span class="status-badge status-{{ patient.status }}">{{ patient.status.title() }}</span>
    </div>
    <div class="detail-row">
      <label>Priority Level:</label>
      <span class="priority-badge priority-{{ patient.priority }}">{{ patient.priority.title() }}</span>
    </div>
    {% if patient.medical_notes %}
    <div class="detail-row full-width">
      <label>Medical Notes:</label>
      <div class="medical-notes">{{ patient.medical_notes | nl2br }}</div>
    </div>
    {% endif %}
  </div>

  <!-- Appointment Summary -->
  <div class="detail-card">
    <h2>Appointment Summary</h2>
    <div class="detail-row">
      <label>Total Appointments:</label>
      <span>{{ patient.total_appointments }}</span>
    </div>
    {% if next_appointment %}
    <div class="detail-row">
      <label>Next Appointment:</label>
      <div class="next-appointment">
        <strong>{{ next_appointment.scheduled_for.strftime('%d %B %Y at %H:%M') }}</strong><br>
        <small>{{ next_appointment.service.name }} - {{ next_appointment.location }}</small>
      </div>
    </div>
    {% else %}
    <div class="detail-row">
      <label>Next Appointment:</label>
      <span>No scheduled appointments</span>
    </div>
    {% endif %}
  </div>
</div>

<!-- Recent Appointments -->
{% if recent_appointments %}
<div class="appointments-section">
  <h2>Recent Appointments</h2>
  <div class="appointments-table">
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Service</th>
          <th>Location</th>
          <th>Status</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in recent_appointments %}
        <tr class="appointment-row status-{{ appointment.status }}">
          <td>
            <strong>{{ appointment.scheduled_for.strftime('%d %b %Y') }}</strong><br>
            <small>{{ appointment.scheduled_for.strftime('%H:%M') }}</small>
          </td>
          <td>{{ appointment.service.name }}</td>
          <td>{{ appointment.location }}</td>
          <td>
            <span class="appointment-status status-{{ appointment.status }}">
              {{ appointment.status.title() }}
            </span>
          </td>
          <td>
            {% if appointment.notes %}
            <span class="notes-preview" title="{{ appointment.notes }}">
              {{ appointment.notes[:50] }}{% if appointment.notes|length > 50 %}...{% endif %}
            </span>
            {% else %}
            <span class="no-notes">No notes</span>
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('appointments.edit', id=appointment.id) }}" class="action-link">Edit</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="no-appointments">
  <h2>No Appointments</h2>
  <p>This patient has no appointment history.</p>
  <a class="button" href="{{ url_for('appointments.create') }}?patient={{ patient.id }}">Schedule First Appointment</a>
</div>
{% endif %}

{% endblock %}